import{d as te,f as o,A as se,B as oe,z as ue,g as d,h as t,l as F,q as ne,j as ie,m as x,t as D,a as ve,w as re,T as ce,n as T,F as de,i as he,k as R,D as I,o as h}from"./vendor-BA6P5Hzh.js";import{s as pe}from"./userArtworkService-BWPUhC9p.js";import{_ as ge}from"./index-4vPGLJHO.js";const fe={class:"digital-drawing-container"},me={class:"drawing-toolbar"},be={class:"toolbar-actions-container"},we={class:"toolbar-actions"},ye=["disabled"],ke=["disabled"],_e={class:"drawing-area"},Ce={class:"tools-panel"},Fe={class:"tools-panel-inner"},xe={key:0,class:"brush-settings"},De={class:"setting-item"},Se={class:"setting-item"},ze=["onClick","title"],Me={class:"tool-icon"},Pe={key:0,class:"save-dialog-overlay"},Te={class:"save-dialog"},Re={class:"input-group"},Ie={key:1,class:"save-success-toast"},$e=20,Be=te({__name:"DigitalDrawing",setup(Ae){const $=ie(),l=o(null),e=o(null),c=o(!1),n=o(5),g=o(.8),m=o("#000000"),E=o(!0),b=o(0),w=o(0),H=o(!0),S=o(!1),C=o(!1),f=o(""),y=o(!1),p=o(""),i=o([]),v=o(-1),U=o(!1),k=o({x:0,y:0}),_=o(!1),B=o([{id:"brush-pen",name:"毛笔",icon:"🖌️",size:8,opacity:.8,color:"#000000"},{id:"ink-pen",name:"钢笔",icon:"✒️",size:2,opacity:1,color:"#000000"},{id:"water-brush",name:"水彩",icon:"💧",size:15,opacity:.4,color:"#4285F4"},{id:"charcoal",name:"炭笔",icon:"✏️",size:6,opacity:.7,color:"#666666"},{id:"eraser",name:"橡皮擦",icon:"🧽",size:15,opacity:1,color:"#FFFFFF"}]),r=o(B.value[0]);se(()=>{if(l.value){const a=l.value.parentElement;a&&(l.value.width=a.clientWidth,l.value.height=a.clientHeight),e.value=l.value.getContext("2d",{willReadFrequently:!0}),e.value&&N(),V(),window.addEventListener("resize",A)}}),oe(()=>{window.removeEventListener("resize",A)});const A=()=>{if(l.value&&e.value){const a=l.value.parentElement;if(a){const s=e.value.getImageData(0,0,l.value.width,l.value.height);l.value.width=a.clientWidth,l.value.height=a.clientHeight,e.value.fillStyle="#FFFFFF",e.value.fillRect(0,0,l.value.width,l.value.height),e.value.putImageData(s,0,0),V()}}},V=()=>{U.value=window.innerWidth<=768},W=()=>{e.value&&(e.value.lineCap="round",e.value.lineJoin="round",r.value.id==="eraser"?(e.value.globalCompositeOperation="destination-out",e.value.lineWidth=n.value,e.value.globalAlpha=1):(e.value.globalCompositeOperation="source-over",e.value.strokeStyle=m.value,e.value.lineWidth=n.value,e.value.globalAlpha=g.value))},Y=a=>{const s=r.value.id===a.id;r.value=a,n.value=a.size,g.value=a.opacity,m.value=a.color,s?_.value=!_.value:_.value=!0},z=()=>{if(e.value&&l.value){v.value<i.value.length-1&&(i.value=i.value.slice(0,v.value+1));const a=e.value.getImageData(0,0,l.value.width,l.value.height);i.value.push(a),i.value.length>$e&&i.value.shift(),v.value=i.value.length-1}},L=()=>{v.value>0&&e.value&&l.value&&(v.value--,e.value.putImageData(i.value[v.value],0,0))},O=()=>{v.value<i.value.length-1&&e.value&&l.value&&(v.value++,e.value.putImageData(i.value[v.value],0,0))},q=()=>{e.value&&l.value&&(e.value.save(),e.value.globalCompositeOperation="source-over",e.value.globalAlpha=1,e.value.clearRect(0,0,l.value.width,l.value.height),e.value.fillStyle="#FFFFFF",e.value.fillRect(0,0,l.value.width,l.value.height),e.value.restore(),z())},N=()=>{e.value&&l.value&&(e.value.fillStyle="#FFFFFF",e.value.fillRect(0,0,l.value.width,l.value.height),z())},j=()=>{if(l.value){C.value=!0;const a=new Date;f.value=`我的作品 ${a.getMonth()+1}月${a.getDate()}日`}},J=()=>{if(l.value&&f.value.trim())try{const a=l.value.toDataURL("image/png");pe(f.value.trim(),a,0),y.value=!0,p.value="作品已保存！您可以在虚拟装裱中使用它。",setTimeout(()=>{y.value=!1,p.value=""},3e3),C.value=!1}catch(a){console.error("保存作品失败:",a),y.value=!1,p.value="保存失败，请重试。"}else f.value.trim()||(y.value=!1,p.value="请输入作品标题")},G=()=>{C.value=!1,f.value="",p.value=""},K=()=>{$.push("/frame")},Q=a=>{c.value=!0,l.value&&"setPointerCapture"in l.value&&l.value.setPointerCapture(a.pointerId),a.preventDefault(),P(a),k.value={x:b.value,y:w.value},e.value&&(e.value.beginPath(),e.value.moveTo(b.value,w.value))},M=a=>{c.value&&(c.value=!1,l.value&&"releasePointerCapture"in l.value&&l.value.releasePointerCapture(a.pointerId),e.value&&(e.value.beginPath(),z()))},P=a=>{if(!l.value)return;const s=l.value.getBoundingClientRect();"touches"in a&&a.touches.length>0?(b.value=a.touches[0].clientX-s.left,w.value=a.touches[0].clientY-s.top):"clientX"in a&&(b.value=a.clientX-s.left,w.value=a.clientY-s.top)},Z=()=>{S.value=!0},ee=()=>{c.value||(S.value=!1)},ae=a=>{if(!c.value||!e.value||!l.value)return;a.preventDefault(),P(a);const s=b.value,u=w.value;if(W(),E.value&&"pressure"in a&&a.pressure!==0&&(e.value.lineWidth=n.value*(.5+a.pressure*1.5)),e.value){e.value.beginPath(),e.value.moveTo(k.value.x,k.value.y);const X=(k.value.x+s)/2,le=(k.value.y+u)/2;e.value.quadraticCurveTo(X,le,s,u),e.value.stroke(),k.value={x:s,y:u}}};return ue([n,m,g],()=>{r.value&&(r.value.size=n.value,r.value.opacity=g.value,r.value.color=m.value)}),(a,s)=>(h(),d("div",fe,[t("div",me,[t("button",{class:"back-button",onClick:s[0]||(s[0]=u=>ne($).push("/interactive"))},"返回"),s[4]||(s[4]=t("h1",null,"数字绘画系统",-1))]),t("div",be,[t("div",we,[t("button",{onClick:L,title:"撤销",disabled:v.value<=0},"↩️",8,ye),t("button",{onClick:O,title:"重做",disabled:v.value>=i.value.length-1},"↪️",8,ke),t("button",{onClick:q,title:"清除画布"},"🗑️"),t("button",{onClick:j,title:"保存作品"},"💾"),t("button",{onClick:K,title:"前往虚拟装裱",class:"frame-button"},"🖼️")])]),t("div",_e,[t("canvas",{ref_key:"canvasRef",ref:l,class:"drawing-canvas",onPointerdown:Q,onPointermove:ae,onPointerup:M,onPointerout:M,onPointercancel:M,onMousemove:P,onMouseenter:Z,onMouseleave:ee,"touch-action":"none",style:{cursor:"none","-webkit-touch-callout":"none","-webkit-user-select":"none","user-select":"none"}},null,544),S.value&&H.value?(h(),d("div",{key:0,class:"custom-cursor",style:x({left:`${b.value}px`,top:`${w.value}px`})},[t("span",{class:"cursor-icon",style:x({fontSize:`${Math.max(18,n.value*1.5)}px`,filter:c.value?"drop-shadow(0 0 3px rgba(0,0,0,0.5))":"drop-shadow(0 0 1px white)",transform:c.value?"scale(0.9) rotate(-15deg)":"scale(1) rotate(0deg)",color:r.value.id==="eraser"?"red":m.value})},D(r.value.icon),5),r.value.id!=="eraser"?(h(),d("div",{key:0,class:"cursor-brush-preview",style:x({width:`${n.value}px`,height:`${n.value}px`,backgroundColor:m.value,opacity:g.value*.3,transform:c.value?"scale(0.8)":"scale(1)"})},null,4)):(h(),d("div",{key:1,class:"cursor-eraser-preview",style:x({width:`${n.value}px`,height:`${n.value}px`,border:"1px dashed red",backgroundColor:"rgba(255, 255, 255, 0.2)",transform:c.value?"scale(0.8)":"scale(1)"})},null,4))],4)):F("",!0)]),t("div",Ce,[t("div",Fe,[ve(ce,{name:"slide-fade"},{default:re(()=>[_.value?(h(),d("div",xe,[t("div",De,[s[5]||(s[5]=t("label",null,"大小",-1)),R(t("input",{type:"range","onUpdate:modelValue":s[1]||(s[1]=u=>n.value=u),min:"1",max:"50",step:"1"},null,512),[[I,n.value]])]),t("div",Se,[s[6]||(s[6]=t("label",null,"透明度",-1)),R(t("input",{type:"range","onUpdate:modelValue":s[2]||(s[2]=u=>g.value=u),min:"0.1",max:"1",step:"0.1"},null,512),[[I,g.value]])])])):F("",!0)]),_:1}),t("div",{class:T(["brush-tools",{"brush-tools-with-settings":_.value}])},[(h(!0),d(de,null,he(B.value,u=>(h(),d("button",{key:u.id,onClick:X=>Y(u),class:T({active:r.value.id===u.id}),title:u.name},[t("span",Me,D(u.icon),1)],10,ze))),128))],2)])]),C.value?(h(),d("div",Pe,[t("div",Te,[s[8]||(s[8]=t("h3",null,"保存我的作品",-1)),t("div",Re,[s[7]||(s[7]=t("label",{for:"artwork-title"},"作品标题",-1)),R(t("input",{type:"text",id:"artwork-title","onUpdate:modelValue":s[3]||(s[3]=u=>f.value=u),placeholder:"请输入作品标题",maxlength:"30"},null,512),[[I,f.value]])]),t("p",{class:T(["save-message",{error:!y.value&&p.value}])},D(p.value),3),t("div",{class:"dialog-buttons"},[t("button",{onClick:G,class:"cancel-button"},"取消"),t("button",{onClick:J,class:"save-button"},"保存")])])])):F("",!0),y.value?(h(),d("div",Ie,[t("p",null,D(p.value),1)])):F("",!0)]))}}),He=ge(Be,[["__scopeId","data-v-ee91a211"]]);export{He as default};
